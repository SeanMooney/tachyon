[tox]
minversion = 4.6.0
envlist = py3,functional,lint,cover
# Skip missing interpreters for local development
skip_missing_interpreters = true

[testenv]
usedevelop = True
allowlist_externals =
    bash
    find
    rm
setenv =
    VIRTUAL_ENV={envdir}
    LANGUAGE=en_US
    LC_ALL=en_US.utf-8
    OS_STDOUT_CAPTURE=1
    OS_STDERR_CAPTURE=1
    OS_LOG_CAPTURE=1
    OS_TEST_TIMEOUT=160
    PYTHONDONTWRITEBYTECODE=1
    # Tests are not part of the package, add to PYTHONPATH
    PYTHONPATH={toxinidir}/tests:{envdir}
deps =
    -r{toxinidir}/requirements.txt
    -r{toxinidir}/test-requirements.txt
passenv =
    OS_DEBUG
    OS_LOG_CAPTURE
    TRACE_FAILONLY
    TACHYON_NEO4J_URI
    TACHYON_NEO4J_USERNAME
    TACHYON_NEO4J_PASSWORD
commands =
    stestr run {posargs}
    stestr slowest

# Python version specific environments
[testenv:{py3,py310,py311,py312,py313}]
description = Run unit tests with Python {basepython}
commands =
    stestr run {posargs}
    stestr slowest

# Functional tests (requires Docker for Neo4j container)
[testenv:functional{,-py310,-py311,-py312,-py313}]
description = Run functional tests with real Neo4j database
commands =
    bash {toxinidir}/tools/functional-tests.sh {posargs}

# Style checks via pre-commit (ruff, mypy, etc.)
[testenv:lint]
description = Run style checks via pre-commit
skip_install = true
deps =
    pre-commit
commands =
    pre-commit run --all-files

# Sync Ruff isort configuration from OpenStack governance projects list
[testenv:sync-isort]
description = Sync Ruff isort config from OpenStack governance
skip_install = true
deps =
    tomlkit
commands =
    python tools/generate_isort_config.py

# Coverage reporting
[testenv:cover]
description = Generate test coverage report
setenv =
    {[testenv]setenv}
    PYTHON=coverage run --source src/tachyon --parallel-mode
commands =
    coverage erase
    stestr run {posargs}
    coverage combine
    coverage html -d cover
    coverage xml -o cover/coverage.xml
    coverage report

# Development environment
[testenv:venv]
description = Virtual environment with all dependencies
commands = {posargs}

# Debug environment
[testenv:debug]
description = Run tests with pdb debugging
commands =
    oslo_debug_helper {posargs}

[flake8]
# H301: one import per line
# H303: No wildcard imports
# H304: No relative imports
# H306: Imports not in alphabetical order
# H401: docstring should not start with a space
# H403: multi-line docstring should end on new line
# H404: multi-line docstring should start without leading space
# H405: docstring summary should not be on multiple lines
show-source = true
# E203 and W503 have false positives with black-style formatting
ignore = E203,W503
exclude = .venv,.git,.tox,dist,doc,*egg,build,.eggs
max-line-length = 79
# Use flake8-import-order to enforce import ordering
import-order-style = pep8
application-import-names = tachyon,tachyon_tests
