fixtures:
  - APIFixture

defaults:
  request_headers:
    x-auth-token: admin
    accept: application/json
    openstack-api-version: placement latest

tests:

# --- Setup ---

- name: setup provider
  POST: /resource_providers
  request_headers:
    content-type: application/json
  data:
    uuid: $ENVIRON['RP_UUID']
    name: alloc-rp
  status: 200

- name: setup inventories for allocations
  PUT: /resource_providers/$ENVIRON['RP_UUID']/inventories
  request_headers:
    content-type: application/json
  data:
    resource_provider_generation: 0
    inventories:
      VCPU:
        total: 8
      MEMORY_MB:
        total: 16384
  status: 200

# --- Error Cases ---

- name: get allocations for nonexistent consumer
  GET: /allocations/nonexistent-consumer
  status: 404
  response_json_paths:
    $.errors[0].status: 404

- name: put allocation without consumer_generation fails
  PUT: /allocations/$ENVIRON['CONSUMER_UUID']
  request_headers:
    content-type: application/json
  data:
    allocations:
      $ENVIRON['RP_UUID']:
        resources:
          VCPU: 2
  status: 400

# --- Successful Allocation ---

- name: put allocation
  PUT: /allocations/$ENVIRON['CONSUMER_UUID']
  request_headers:
    content-type: application/json
  data:
    consumer_generation: 0
    allocations:
      $ENVIRON['RP_UUID']:
        resources:
          VCPU: 2
          MEMORY_MB: 1024
  status: 200
  response_json_paths:
    $.consumer_generation: 1

- name: get allocation
  GET: /allocations/$ENVIRON['CONSUMER_UUID']
  status: 200
  response_json_paths:
    $.consumer_generation: 1

# --- Update Allocation ---

- name: update allocation with wrong generation fails
  PUT: /allocations/$ENVIRON['CONSUMER_UUID']
  request_headers:
    content-type: application/json
  data:
    consumer_generation: 0
    allocations:
      $ENVIRON['RP_UUID']:
        resources:
          VCPU: 4
  status: 409
  response_json_paths:
    $.errors[0].status: 409

- name: update allocation
  PUT: /allocations/$ENVIRON['CONSUMER_UUID']
  request_headers:
    content-type: application/json
  data:
    consumer_generation: 1
    allocations:
      $ENVIRON['RP_UUID']:
        resources:
          VCPU: 4
  status: 200
  response_json_paths:
    $.consumer_generation: 2

# --- Provider Allocations ---

- name: get provider allocations
  GET: /resource_providers/$ENVIRON['RP_UUID']/allocations
  status: 200

# --- Delete Allocation ---

- name: delete allocations
  DELETE: /allocations/$ENVIRON['CONSUMER_UUID']
  status: 204

- name: verify allocations empty after delete
  GET: /allocations/$ENVIRON['CONSUMER_UUID']
  status: 200
  response_json_paths:
    # Consumer still exists but has no allocations
    $.allocations: {}
