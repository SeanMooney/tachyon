fixtures:
  - APIFixture

defaults:
  request_headers:
    x-auth-token: admin
    accept: application/json
    openstack-api-version: placement latest

tests:

# --- Setup ---

- name: setup provider
  POST: /resource_providers
  request_headers:
    content-type: application/json
  data:
    uuid: $ENVIRON['RP_UUID']
    name: alloc-rp
  status: 200

- name: setup inventories for allocations
  PUT: /resource_providers/$ENVIRON['RP_UUID']/inventories
  request_headers:
    content-type: application/json
  data:
    resource_provider_generation: 0
    inventories:
      VCPU:
        total: 8
      MEMORY_MB:
        total: 16384
  status: 200

# --- Non-existent consumer returns empty allocations ---

- name: get allocations for nonexistent consumer returns empty
  desc: Per Placement API spec, non-existent consumer returns empty allocations, not 404
  GET: /allocations/nonexistent-consumer
  status: 200
  response_json_paths:
    $.allocations: {}

- name: put allocation without consumer_generation fails
  PUT: /allocations/$ENVIRON['CONSUMER_UUID']
  request_headers:
    content-type: application/json
  data:
    project_id: $ENVIRON['PROJECT_ID']
    user_id: $ENVIRON['USER_ID']
    consumer_type: INSTANCE
    allocations:
      $ENVIRON['RP_UUID']:
        resources:
          VCPU: 2
  status: 400
  response_strings:
    - "'consumer_generation' is a required field"

# --- consumer_generation: null tests ---

- name: put allocation with null consumer_generation for new consumer
  desc: consumer_generation null means "expect new consumer" - should succeed
  PUT: /allocations/$ENVIRON['CONSUMER_UUID1']
  request_headers:
    content-type: application/json
  data:
    consumer_generation: null
    project_id: $ENVIRON['PROJECT_ID']
    user_id: $ENVIRON['USER_ID']
    consumer_type: INSTANCE
    allocations:
      $ENVIRON['RP_UUID']:
        resources:
          VCPU: 1
  status: 204

- name: put allocation with null consumer_generation for existing consumer fails
  desc: consumer_generation null for existing consumer should fail with 409
  PUT: /allocations/$ENVIRON['CONSUMER_UUID1']
  request_headers:
    content-type: application/json
  data:
    consumer_generation: null
    project_id: $ENVIRON['PROJECT_ID']
    user_id: $ENVIRON['USER_ID']
    consumer_type: INSTANCE
    allocations:
      $ENVIRON['RP_UUID']:
        resources:
          VCPU: 2
  status: 409
  response_json_paths:
    $.errors[0].status: 409

- name: cleanup consumer1 allocations
  DELETE: /allocations/$ENVIRON['CONSUMER_UUID1']
  status: 204

# --- Successful Allocation ---

- name: put allocation
  PUT: /allocations/$ENVIRON['CONSUMER_UUID']
  request_headers:
    content-type: application/json
  data:
    consumer_generation: null
    project_id: $ENVIRON['PROJECT_ID']
    user_id: $ENVIRON['USER_ID']
    consumer_type: INSTANCE
    allocations:
      $ENVIRON['RP_UUID']:
        resources:
          VCPU: 2
          MEMORY_MB: 1024
  status: 204

- name: get allocation
  desc: Verify project_id and user_id are returned in GET response (microversion 1.12+)
  GET: /allocations/$ENVIRON['CONSUMER_UUID']
  status: 200
  response_json_paths:
    $.consumer_generation: 1
    $.project_id: $ENVIRON['PROJECT_ID']
    $.user_id: $ENVIRON['USER_ID']

# --- Update Allocation ---

- name: update allocation with wrong generation fails
  PUT: /allocations/$ENVIRON['CONSUMER_UUID']
  request_headers:
    content-type: application/json
  data:
    consumer_generation: 0
    project_id: $ENVIRON['PROJECT_ID']
    user_id: $ENVIRON['USER_ID']
    consumer_type: INSTANCE
    allocations:
      $ENVIRON['RP_UUID']:
        resources:
          VCPU: 4
  status: 409
  response_json_paths:
    $.errors[0].status: 409

- name: update allocation
  PUT: /allocations/$ENVIRON['CONSUMER_UUID']
  request_headers:
    content-type: application/json
  data:
    consumer_generation: 1
    project_id: $ENVIRON['PROJECT_ID']
    user_id: $ENVIRON['USER_ID']
    consumer_type: INSTANCE
    allocations:
      $ENVIRON['RP_UUID']:
        resources:
          VCPU: 4
  status: 204

# --- Provider Allocations ---

- name: get provider allocations
  GET: /resource_providers/$ENVIRON['RP_UUID']/allocations
  status: 200

# --- Delete Allocation ---

- name: delete allocations
  DELETE: /allocations/$ENVIRON['CONSUMER_UUID']
  status: 204

- name: verify allocations empty after delete
  GET: /allocations/$ENVIRON['CONSUMER_UUID']
  status: 200
  response_json_paths:
    # Consumer still exists but has no allocations
    $.allocations: {}
