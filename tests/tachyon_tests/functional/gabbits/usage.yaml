fixtures:
  - APIFixture

defaults:
  request_headers:
    x-auth-token: admin
    accept: application/json
    openstack-api-version: placement latest

tests:

# --- Setup ---

- name: setup provider
  POST: /resource_providers
  request_headers:
    content-type: application/json
  data:
    uuid: $ENVIRON['RP_UUID']
    name: usage-rp
  status: 200

- name: setup inventories for usage
  PUT: /resource_providers/$ENVIRON['RP_UUID']/inventories
  request_headers:
    content-type: application/json
  data:
    resource_provider_generation: 0
    inventories:
      VCPU:
        total: 8
      MEMORY_MB:
        total: 16384
  status: 200

# --- Error Cases ---

- name: get usage for nonexistent provider
  GET: /resource_providers/nonexistent-uuid/usages
  status: 404
  response_json_paths:
    $.errors[0].status: 404

# --- Empty Usage ---

- name: get usage with no allocations
  GET: /resource_providers/$ENVIRON['RP_UUID']/usages
  status: 200
  response_json_paths:
    $.usages.VCPU: 0
    $.usages.MEMORY_MB: 0

# --- Create Allocation ---

- name: put allocation for usage
  PUT: /allocations/$ENVIRON['CONSUMER_UUID']
  request_headers:
    content-type: application/json
  data:
    consumer_generation: null
    project_id: $ENVIRON['PROJECT_ID']
    user_id: $ENVIRON['USER_ID']
    consumer_type: INSTANCE
    allocations:
      $ENVIRON['RP_UUID']:
        resources:
          VCPU: 2
          MEMORY_MB: 1024
  status: 204

# --- Verify Usage ---

- name: get usage with allocations
  GET: /resource_providers/$ENVIRON['RP_UUID']/usages
  status: 200
  response_json_paths:
    $.usages.VCPU: 2
    $.usages.MEMORY_MB: 1024
    $.resource_provider_generation: 1

# --- Delete Allocation and Verify ---

- name: delete allocations
  DELETE: /allocations/$ENVIRON['CONSUMER_UUID']
  status: 204

- name: get usage after deletion
  GET: /resource_providers/$ENVIRON['RP_UUID']/usages
  status: 200
  response_json_paths:
    $.usages.VCPU: 0
    $.usages.MEMORY_MB: 0

# --- Cache Header Tests (1.15+) ---

- name: usages without cache headers before 1.15
  GET: /resource_providers/$ENVIRON['RP_UUID']/usages
  request_headers:
    openstack-api-version: placement 1.14
  status: 200
  response_forbidden_headers:
    - cache-control
    - last-modified

- name: usages with cache headers at 1.15
  GET: /resource_providers/$ENVIRON['RP_UUID']/usages
  request_headers:
    openstack-api-version: placement 1.15
  status: 200
  response_headers:
    cache-control: no-cache
    last-modified: /^\w+, \d+ \w+ \d{4} [\d:]+ GMT$/

# --- Project Usages Endpoint (1.9+) ---

- name: project usages before 1.9
  GET: /usages?project_id=$ENVIRON['PROJECT_ID']
  request_headers:
    openstack-api-version: placement 1.8
  status: 404

- name: project usages missing project_id
  GET: /usages
  request_headers:
    openstack-api-version: placement 1.9
  status: 400
  response_strings:
    - "'project_id' is a required property"

# Create allocations with project_id for testing (use new consumer for clean state)
- name: put allocation with project id
  PUT: /allocations/$ENVIRON['CONSUMER_UUID2']
  request_headers:
    content-type: application/json
    openstack-api-version: placement 1.28
  data:
    consumer_generation: null
    project_id: $ENVIRON['PROJECT_ID']
    user_id: $ENVIRON['USER_ID']
    allocations:
      $ENVIRON['RP_UUID']:
        resources:
          VCPU: 2
          MEMORY_MB: 1024
  status: 204

- name: project usages works at 1.9
  GET: /usages?project_id=$ENVIRON['PROJECT_ID']
  request_headers:
    openstack-api-version: placement 1.9
  status: 200
  response_json_paths:
    $.usages.VCPU: 2
    $.usages.MEMORY_MB: 1024

- name: project usages with cache headers at 1.15
  GET: /usages?project_id=$ENVIRON['PROJECT_ID']
  request_headers:
    openstack-api-version: placement 1.15
  status: 200
  response_headers:
    cache-control: no-cache
    last-modified: /^\w+, \d+ \w+ \d{4} [\d:]+ GMT$/

# --- Consumer Type Tests (1.38+) ---

# Update allocation with consumer_type
- name: update allocation with consumer_type INSTANCE
  PUT: /allocations/$ENVIRON['CONSUMER_UUID']
  request_headers:
    content-type: application/json
    openstack-api-version: placement 1.38
  data:
    consumer_generation: 1
    project_id: $ENVIRON['PROJECT_ID']
    user_id: $ENVIRON['USER_ID']
    consumer_type: INSTANCE
    allocations:
      $ENVIRON['RP_UUID']:
        resources:
          VCPU: 2
          MEMORY_MB: 1024
  status: 204

# Create second allocation with different consumer_type
- name: create MIGRATION type allocation
  PUT: /allocations/$ENVIRON['CONSUMER_UUID1']
  request_headers:
    content-type: application/json
    openstack-api-version: placement 1.38
  data:
    consumer_generation: null
    project_id: $ENVIRON['PROJECT_ID']
    user_id: $ENVIRON['USER_ID']
    consumer_type: MIGRATION
    allocations:
      $ENVIRON['RP_UUID']:
        resources:
          VCPU: 1
          MEMORY_MB: 512
  status: 204

- name: project usages grouped by consumer_type at 1.38
  GET: /usages?project_id=$ENVIRON['PROJECT_ID']
  request_headers:
    openstack-api-version: placement 1.38
  status: 200
  response_json_paths:
    $.usages.INSTANCE.consumer_count: 1
    $.usages.INSTANCE.VCPU: 2
    $.usages.INSTANCE.MEMORY_MB: 1024
    $.usages.MIGRATION.consumer_count: 1
    $.usages.MIGRATION.VCPU: 1
    $.usages.MIGRATION.MEMORY_MB: 512

- name: project usages filter by consumer_type
  GET: /usages?project_id=$ENVIRON['PROJECT_ID']&consumer_type=INSTANCE
  request_headers:
    openstack-api-version: placement 1.38
  status: 200
  response_json_paths:
    $.usages.`len`: 1
    $.usages.INSTANCE.consumer_count: 1
    $.usages.INSTANCE.VCPU: 2

- name: project usages with consumer_type all aggregates
  GET: /usages?project_id=$ENVIRON['PROJECT_ID']&consumer_type=all
  request_headers:
    openstack-api-version: placement 1.38
  status: 200
  response_json_paths:
    $.usages.`len`: 1
    # 3 consumers: CONSUMER_UUID (INSTANCE), CONSUMER_UUID1 (MIGRATION), CONSUMER_UUID2 (unknown/1.28)
    $.usages.all.consumer_count: 3
    $.usages.all.VCPU: 5
    $.usages.all.MEMORY_MB: 2560

- name: project usages consumer_type parameter ignored before 1.38
  GET: /usages?project_id=$ENVIRON['PROJECT_ID']&consumer_type=INSTANCE
  request_headers:
    openstack-api-version: placement 1.37
  status: 200
  response_json_paths:
    # Before 1.38, consumer_type param is ignored, returns simple aggregated usages
    # Includes all 3 consumers: INSTANCE (2 VCPU), MIGRATION (1 VCPU), unknown (2 VCPU)
    $.usages.VCPU: 5
    $.usages.MEMORY_MB: 2560
