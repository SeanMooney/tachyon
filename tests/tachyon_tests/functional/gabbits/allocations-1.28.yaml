# Tests for microversion 1.28 - consumer_generation required
# Port of Placement's allocations-1.28.yaml

fixtures:
    - APIFixture

defaults:
    request_headers:
        x-auth-token: admin
        accept: application/json
        content-type: application/json
        openstack-api-version: placement 1.28

# Scenarios to test
# Start with no consumers
#    old, no CG = success, consumer gets created
#    new, no CG = fail, due to schema
#    new, CG=None = success, consumer gets created
#    new, CG=<any> = fail
# Create an allocation, and with it, a consumer
# Now create another allocation
#    old, no CG = success
#    new, CG=None = fail
#    new, CG !match = fail
#    new, get CG from /allocations
#    new, CG matches = success

tests:

# Setup - create resource provider with inventory
- name: create resource provider
  POST: /resource_providers
  data:
      name: $ENVIRON['RP_NAME']
      uuid: $ENVIRON['RP_UUID']
  status: 200

- name: set inventory
  PUT: /resource_providers/$ENVIRON['RP_UUID']/inventories
  data:
      resource_provider_generation: 0
      inventories:
          DISK_GB:
            total: 2048
            min_unit: 10
            max_unit: 1024
          VCPU:
            total: 96
  status: 200

# Non-existent consumer tests at old and new versions

- name: old version get nonexistent
  GET: /allocations/11111111-1111-1111-1111-111111111111
  request_headers:
      openstack-api-version: placement 1.27
  response_json_paths:
      # This is the entire response. There is no generation or proj/user id.
      $:
        allocations: {}

- name: new version get nonexistent
  GET: /allocations/22222222-2222-2222-2222-222222222222
  response_json_paths:
      # This is the entire response. There is no generation or proj/user id.
      $:
        allocations: {}

# Test: old version, no consumer_generation, no existing consumer -> success
- name: old version no gen no existing
  PUT: /allocations/11111111-1111-1111-1111-111111111111
  request_headers:
      openstack-api-version: placement 1.27
  data:
      allocations:
          $ENVIRON['RP_UUID']:
            resources:
              DISK_GB: 10
      project_id: $ENVIRON['PROJECT_ID']
      user_id: $ENVIRON['USER_ID']
  status: 204

# Test: new version, no consumer_generation, no existing consumer -> fail (schema)
- name: new version no gen no existing fails
  PUT: /allocations/22222222-2222-2222-2222-222222222222
  data:
      allocations:
          $ENVIRON['RP_UUID']:
            resources:
              DISK_GB: 10
      project_id: $ENVIRON['PROJECT_ID']
      user_id: $ENVIRON['USER_ID']
  status: 400
  response_strings:
    - "'consumer_generation' is a required field"
  response_json_paths:
      $.errors[0].title: Bad Request

# Test: new version, consumer_generation is not null, no existing consumer -> fail 409
- name: new version gen is not null no existing
  PUT: /allocations/22222222-2222-2222-2222-222222222222
  data:
      allocations:
          $ENVIRON['RP_UUID']:
            resources:
              DISK_GB: 10
      project_id: $ENVIRON['PROJECT_ID']
      user_id: $ENVIRON['USER_ID']
      consumer_generation: 5
  status: 409
  response_strings:
    - consumer generation conflict
  response_json_paths:
      $.errors[0].code: placement.concurrent_update

# Test: new version, consumer_generation is null, no existing consumer -> success
- name: new version gen is null no existing
  PUT: /allocations/22222222-2222-2222-2222-222222222222
  data:
      allocations:
          $ENVIRON['RP_UUID']:
            resources:
              DISK_GB: 10
      project_id: $ENVIRON['PROJECT_ID']
      user_id: $ENVIRON['USER_ID']
      consumer_generation: null
  status: 204

# Test: new version, any gen, no existing -> conflict
- name: new version any gen no existing
  PUT: /allocations/33333333-3333-3333-3333-333333333333
  data:
      allocations:
          $ENVIRON['RP_UUID']:
            resources:
              DISK_GB: 10
      project_id: $ENVIRON['PROJECT_ID']
      user_id: $ENVIRON['USER_ID']
      consumer_generation: 33
  status: 409
  response_strings:
    - consumer generation conflict

# Now create an allocation for a specific consumer
- name: put an allocation for new consumer
  PUT: /allocations/44444444-4444-4444-4444-444444444444
  data:
      allocations:
          $ENVIRON['RP_UUID']:
              resources:
                DISK_GB: 10
      project_id: $ENVIRON['PROJECT_ID']
      user_id: $ENVIRON['USER_ID']
      consumer_generation: null
  status: 204

# Test: new version, null gen, existing consumer -> fail 409
- name: new version null gen existing fails
  PUT: /allocations/44444444-4444-4444-4444-444444444444
  data:
      allocations:
          $ENVIRON['RP_UUID']:
              resources:
                DISK_GB: 10
      project_id: $ENVIRON['PROJECT_ID']
      user_id: $ENVIRON['USER_ID']
      consumer_generation: null
  status: 409
  response_strings:
    - consumer generation conflict

# Get the current consumer generation
- name: get the current consumer generation
  GET: /allocations/44444444-4444-4444-4444-444444444444
  status: 200

# Test: new version, matching gen, existing consumer -> success
- name: new version matching gen existing
  PUT: /allocations/44444444-4444-4444-4444-444444444444
  data:
      allocations:
          $ENVIRON['RP_UUID']:
              resources:
                DISK_GB: 10
      project_id: $ENVIRON['PROJECT_ID']
      user_id: $ENVIRON['USER_ID']
      consumer_generation: $HISTORY["get the current consumer generation"].$RESPONSE["consumer_generation"]
  status: 204

# Test: new version, mismatch gen, existing consumer -> fail 409
- name: new version mismatch gen existing
  PUT: /allocations/44444444-4444-4444-4444-444444444444
  data:
      allocations:
          $ENVIRON['RP_UUID']:
              resources:
                DISK_GB: 10
      project_id: $ENVIRON['PROJECT_ID']
      user_id: $ENVIRON['USER_ID']
      consumer_generation: 12
  status: 409
  response_strings:
    - consumer generation conflict
  response_json_paths:
      $.errors[0].code: placement.concurrent_update

# Test: old version, no gen, existing consumer -> success
- name: old version no gen existing
  PUT: /allocations/44444444-4444-4444-4444-444444444444
  request_headers:
      openstack-api-version: placement 1.27
  data:
      allocations:
          $ENVIRON['RP_UUID']:
            resources:
              DISK_GB: 10
      project_id: $ENVIRON['PROJECT_ID']
      user_id: $ENVIRON['USER_ID']
  status: 204

# Verify consumer_generation is in response at 1.28+
- name: new version serialization contains consumer generation
  GET: /allocations/44444444-4444-4444-4444-444444444444
  status: 200
  response_json_paths:
      $.consumer_generation: /^\d+$/

# Test: empty allocations dict with consumer_generation
- name: empty allocations dict removes allocations
  PUT: /allocations/44444444-4444-4444-4444-444444444444
  data:
      allocations: {}
      project_id: $ENVIRON['PROJECT_ID']
      user_id: $ENVIRON['USER_ID']
      consumer_generation: $HISTORY["new version serialization contains consumer generation"].$RESPONSE["consumer_generation"]
  status: 204

# Verify allocations removed at old version
- name: old version should now return no allocations for this consumer
  GET: /allocations/44444444-4444-4444-4444-444444444444
  request_headers:
      openstack-api-version: placement 1.27
  status: 200
  response_json_paths:
      $:
        allocations: {}

# Verify allocations removed at new version
- name: new version should now return no allocations for this consumer
  GET: /allocations/44444444-4444-4444-4444-444444444444
  status: 200
  response_json_paths:
      $:
        allocations: {}
